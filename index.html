<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My BookTok Shelf</title>
  <!-- Meta preview (LinkedIn, X, etc.) -->
<meta property="og:title" content="Aesthetic Bookshelf" />
<meta property="og:description" content="Drag and arrange vintage book covers on a cozy BookTok-inspired digital shelf with fairy lights and themes." />
<meta property="og:image" content="https://github.com/jeanmhuang/bookshelf/blob/main/thumbnail.png?raw=true" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jeanmhuang.github.io/bookshelf/" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Aesthetic Bookshelf" />
<meta name="twitter:description" content="Build your cozy digital bookshelf with vintage covers and fairy lights." />
<meta name="twitter:image" content="https://github.com/jeanmhuang/bookshelf/blob/main/thumbnail.png?raw=true" />

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>ðŸ“š</text></svg>">

<meta name="description" content="Aesthetic BookTok shelf: drag vintage book covers from multiple editions, tilt 10Â°, drag-reposition, tidy spacing, fairy lights, clear shelves, save PNG, and cozy style themes." />
<link rel="preconnect" href="https://openlibrary.org">
<link rel="preconnect" href="https://covers.openlibrary.org">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<style>
/* ========= THEME TOKENS ========= */
:root{
  /* neutrals */
  --bg:#f6f1ee; --ink:#2c2624; --muted:#7b6d66; --pearl:#fffbf7;
  /* woods */
  --wood1:#b07a52; --wood2:#6f4b34;
  /* board */
  --board-top:#f6ebe3; --board-bot:#fffdfa;
  --shadow:0 16px 44px rgba(0,0,0,.10);
  /* other */
  --gutter:12px; --book-pad:6px;
  /* fairy bulbs */
  --bulb-1:#e4b864;  /* darker amber */
  --bulb-2:#e08a8a;  /* deeper rose */
  --bulb-3:#9ec7ef;  /* dusk blue */
  --wire:#5f4b3d;    /* visible wire */
}

/* Dark Academia */
.theme-dark {
  --bg:#f0ece6; --ink:#231f1c; --muted:#6b625c; --pearl:#f8f5ef;
  --wood1:#5a4637; --wood2:#382c22;
  --board-top:#d8d1c9; --board-bot:#efeae3;
  --bulb-1:#d6a44e; --bulb-2:#cc7676; --bulb-3:#86b4e6; --wire:#3b2e25;
}

/* Coquette */
.theme-coquette {
  --bg:#fff6fb; --ink:#403234; --muted:#7a6166; --pearl:#fff9fd;
  --wood1:#c79a92; --wood2:#8f6b64;
  --board-top:#ffe7f3; --board-bot:#fffafd;
  --bulb-1:#f1a6c7; --bulb-2:#ffb36e; --bulb-3:#b9d9ff; --wire:#7b5c61;
}

/* Cottagecore */
.theme-cottage {
  --bg:#f4f8f2; --ink:#2d2d26; --muted:#6a6d5e; --pearl:#f8fbf5;
  --wood1:#a4875d; --wood2:#6c5a3d;
  --board-top:#edf3e9; --board-bot:#ffffff;
  --bulb-1:#e0c25a; --bulb-2:#d7866d; --bulb-3:#97c6f0; --wire:#5a4f3a;
}

*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#ffffff 60%);color:var(--ink);font:16px/1.45 ui-serif,Georgia,serif;transition:background .25s ease}

/* Header */
header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#fff,#fffaf8);border-bottom:1px solid #eadfd9;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.bar{max-width:1400px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}
label{font:15px/1.2 ui-sans-serif,system-ui;color:#4a3f39;display:flex;align-items:center;gap:8px}
select,input[type=checkbox]{padding:6px 10px;border-radius:10px;border:1px solid #e3d7cf;background:#fff}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#222;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.12)}
.btn.ghost{background:#fff;border:1px solid #e3d7cf;color:#3a2e2a}
.btn:disabled{opacity:.6;cursor:not-allowed}
.instructions{font:14px/1.55 ui-sans-serif,system-ui;color:#5b4e47;margin:6px auto 10px;text-align:center;max-width:1200px}

/* Layout */
main{max-width:1400px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:420px 1fr;gap:18px}
@media (max-width:1100px){ main{grid-template-columns:1fr} }

.panel{background:linear-gradient(180deg,#fff,#fffaf8);border:1px solid #eee;border-radius:20px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.05)}
.panel h2{font-size:18px;margin:0;padding:12px 14px;border-bottom:1px solid #f0e8e3;background:linear-gradient(90deg,#fff,#fff7f2)}
.panel .content{padding:12px}
.pill{display:flex;gap:8px;align-items:center;background:var(--pearl);border:1px solid #eadfd9;border-radius:999px;padding:8px 10px;margin-bottom:10px}
.pill input{all:unset;flex:1;font:15px/1.2 ui-sans-serif,system-ui;color:#333}
.controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.results{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:520px){ .results{grid-template-columns:repeat(2,1fr)} }

.book-card{position:relative;border-radius:12px;overflow:hidden;background:#f5f1ee;border:1px solid #e9dfd8;display:flex;align-items:center;justify-content:center;cursor:grab;min-height:170px}
.book-card img{width:100%;height:100%;object-fit:cover;display:block}

/* Workspace */
.workspace{display:flex;flex-direction:column;gap:12px}
.board-outer{display:flex;justify-content:center;align-items:center;padding:8px}
.board{
  position:relative;
  width:620px;                 /* in-between width */
  height:700px;
  border-radius:22px;
  background:linear-gradient(180deg,var(--board-top),var(--board-bot));
  box-shadow: inset 0 0 0 1px #ead8cf, inset 0 30px 80px rgba(190,150,120,.20), var(--shadow);
  overflow:hidden;
  transition:background .25s ease;
}
@media (min-width:1200px){
  .board{ width:820px; height:900px; } /* larger but not the previous widest */
}
.board::before,.board::after{content:"";position:absolute;top:0;bottom:0;width:12px;background:linear-gradient(180deg,#ccb19a,#b69074);box-shadow:inset 0 1px 0 #fff6}
.board::before{left:0;border-radius:22px 0 0 22px}
.board::after{right:0;border-radius:0 22px 22px 0}

/* Fairy lights (darker & more visible) */
.fairy{
  position:absolute;top:54px;left:20px;right:20px;height:30px;
  display:flex;justify-content:space-between;align-items:center;z-index:6;pointer-events:none
}
.fairy::before{
  content:""; position:absolute; left:0; right:0; top:15px; height:2px; background:var(--wire); opacity:.55;
}
.fairy.hidden{visibility:hidden}
.bulb{
  width:12px; height:12px; border-radius:50%;
  background:var(--bulb-1);
  box-shadow:0 0 10px rgba(0,0,0,.35), 0 0 12px currentColor, 0 0 4px currentColor;
  animation:twinkle 1.8s ease-in-out infinite alternate;
  opacity:.95;
}
.bulb:nth-child(3n){ background:var(--bulb-2); }
.bulb:nth-child(3n+1){ background:var(--bulb-3); }
.bulb:nth-child(odd){ animation-duration:2.2s }
.bulb:nth-child(4n){ animation-duration:1.6s }
@keyframes twinkle{0%{filter:brightness(.9)}100%{filter:brightness(1.25)}}

/* Shelves & layering */
.shelves{position:absolute;inset:82px 10px 140px 10px; z-index:1;}
.shelf{
  position:absolute;left:8px;right:8px;border-radius:12px;
  background:linear-gradient(180deg,var(--wood1),var(--wood2));
  box-shadow:0 12px 26px rgba(0,0,0,.32), inset 0 2px 0 rgba(255,255,255,.25);
  border:1px solid rgba(0,0,0,.28)
}
.shelf .plaque{
  position:absolute;bottom:8px;left:50%;transform:translateX(-50%);
  padding:3px 12px;border-radius:12px;
  background:linear-gradient(180deg,#f6efe6,#ebdccf);
  border:1px solid #d6c2af;color:#6a5342;
  font:12px/1.1 ui-sans-serif,system-ui;box-shadow:inset 0 1px 0 #fff6
}

/* Books (covers only) */
.book{
  position:absolute;bottom:var(--book-pad);max-height:calc(100% - (var(--book-pad)*2));
  border-radius:10px;box-shadow:0 12px 22px rgba(0,0,0,.30);
  transform:rotate(var(--rot, 0deg));transform-origin:bottom center;
  cursor:grab;user-select:none;transition:transform .2s ease, filter .2s ease, box-shadow .15s ease; z-index:4;
}
.book:active{cursor:grabbing}
.book:hover{filter:brightness(1.05)}
.book.selected{box-shadow:0 0 0 3px #ffd7d7, 0 12px 22px rgba(0,0,0,.30)}
.book img{height:100%;width:auto;object-fit:contain;border-radius:10px;display:block}
.book::after{content:"";position:absolute;inset:0;border-radius:10px;background:linear-gradient(90deg, rgba(0,0,0,.12), transparent 18%, transparent 82%, rgba(255,255,255,.20));mix-blend-mode:soft-light;pointer-events:none}

/* Remove control */
.remove-btn{position:absolute;top:-6px;right:-6px;width:26px;height:26px;border-radius:999px;background:#fff;border:1px solid #e1c9c0;box-shadow:0 4px 10px rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;font:700 16px/1 ui-sans-serif,system-ui;color:#7a4a3a;opacity:0;transition:opacity .15s ease;cursor:pointer; z-index:5;}
.book:hover .remove-btn{opacity:1}

/* Large plants in front */
.plant{
  position:absolute; bottom:6px; width:210px; height:210px;
  border-radius:18px; overflow:hidden; box-shadow:0 8px 18px rgba(0,0,0,.25);
  background-size:contain; background-position:center bottom; background-repeat:no-repeat;
  z-index:5; pointer-events:none;
}
.plant.left{left:4px;background-image:url('https://raw.githubusercontent.com/jeanmhuang/bookshelf/main/plants.png')}
.plant.right{right:4px;background-image:url('https://raw.githubusercontent.com/jeanmhuang/bookshelf/main/plants2.png')}
</style>
</head>
<footer style="text-align:center; font-family:ui-sans-serif,system-ui; color:#6b5b4e; font-size:14px; margin:20px 0;">
  Visitor Counter:
  <img src="https://visitor-badge.laobi.icu/badge?page_id=jeanmhuang.bookshelf" alt="Visitors" />
</footer>  
<body class="theme-classic">
<header>
  <div class="bar">
    <h1 style="flex:1;text-align:center;font-family:'Georgia',serif;font-size:28px;font-weight:700;color:#3a2e2a;letter-spacing:.5px">âœ¨ BookTok Aesthetic Bookshelf</h1>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center">
      <label>Style:
        <select id="styleSel">
          <option value="classic" selected>Classic</option>
          <option value="dark">Dark Academia</option>
          <option value="coquette">Coquette</option>
          <option value="cottage">Cottagecore</option>
        </select>
      </label>
      <label>Shelves:
        <select id="shelfCount">
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
        </select>
      </label>
      <label><input type="checkbox" id="lights" checked> Fairy Lights</label>
      <button class="btn ghost" id="clearBtn" title="Remove all books">Clear Shelves</button>
      <button class="btn" id="saveBtn" title="Save bookshelf as PNG">Save PNG</button>
    </div>
  </div>
  <div class="instructions">
    Drag a cover onto a shelf. <strong>Double-click</strong> a book to tilt <strong>10Â°</strong>. Click-hold a placed book to drag-reposition; it keeps tidy spacing on release.
    <strong>Remove:</strong> click âœ• on hover, or select (pink outline) and press <strong>Delete</strong>/<strong>Backspace</strong>.
  </div>
</header>

<main>
  <section class="panel" aria-label="Discover and search">
    <h2>Discover Vintage Covers</h2>
    <div class="content">
      <div class="controls-row">
        <div class="pill" style="flex:1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.3-4.3" stroke="#7b6d66" stroke-width="1.6" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#7b6d66" stroke-width="1.6" fill="none"/></svg>
          <input id="q" placeholder="Search a classic (e.g., Pride and Prejudice) â€” shows many different vintage covers"/>
          <button class="btn" id="go" aria-label="Search">Search</button>
        </div>
      </div>
      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </section>

  <section class="workspace">
    <div class="board-outer">
      <div class="board" id="board">
        <div class="fairy" id="fairy" aria-hidden="true"></div>
        <div id="shelves" class="shelves"></div>
        <div class="plant left" aria-hidden="true"></div>
        <div class="plant right" aria-hidden="true"></div>
      </div>
    </div>
  </section>
</main>

<script>
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const resultsEl     = $('#results');
const board         = $('#board');
const shelvesEl     = $('#shelves');
const shelfCountSel = $('#shelfCount');
const styleSel      = $('#styleSel');
const lightsToggle  = $('#lights');
const fairy         = $('#fairy');
const clearBtn      = $('#clearBtn');
const saveBtn       = $('#saveBtn');

let selectedBook = null;

/* ========= Shelves ========= */
function renderShelves(count=3){
  shelvesEl.innerHTML='';
  const labels = count===2 ? ['Favorites','Classics'] :
                 count===4 ? ['Top Picks','Favorites','TBR','Classics'] :
                             ['Top Picks','TBR','Classics'];
  const rect = board.getBoundingClientRect();
  const boardH = (rect.height || board.offsetHeight || 700);
  const topPad = 92, bottomPad = 150; // space for plants
  const avail  = boardH - topPad - bottomPad;
  const minGap = 10;
  const shelfH = Math.floor((avail - minGap*(count-1)) / count);

  for(let i=0;i<count;i++){
    const shelf=document.createElement('div');
    shelf.className='shelf';
    shelf.style.top = (topPad + i*(shelfH+minGap)) + 'px';
    shelf.style.height = shelfH + 'px';

    const plaque=document.createElement('div');
    plaque.className='plaque';
    plaque.textContent=labels[i]||`Shelf ${i+1}`;
    shelf.appendChild(plaque);
    shelvesEl.appendChild(shelf);
  }
  bindShelfDnD();
}

/* ========= DnD from Discover ========= */
function bindShelfDnD(){
  $$('.shelf').forEach(shelf => {
    shelf.addEventListener('dragover', e => e.preventDefault());
    shelf.addEventListener('drop', e => {
      e.preventDefault();
      try{
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const rect = shelf.getBoundingClientRect();
        const x = e.clientX - rect.left;
        placeBookOnShelf(shelf, data, x);
      }catch(err){ console.warn('drop parse err', err); }
    });
  });
}

/* ========= Place + horizontal drag ========= */
function placeBookOnShelf(shelf,{src},x){
  const book = document.createElement('div');
  book.className = 'book';
  book.style.setProperty('--rot','0deg');

  book.addEventListener('click', (e)=>{
    if(selectedBook) selectedBook.classList.remove('selected');
    selectedBook = book;
    book.classList.add('selected');
    e.stopPropagation();
  });

  // double-click tilt Â±10Â°
  book.addEventListener('dblclick', ()=>{
    const current = (book.style.getPropertyValue('--rot')||'0deg').replace('deg','');
    const cur = parseFloat(current)||0;
    const next = cur===0 ? (Math.random()<.5?10:-10) : 0;
    book.style.setProperty('--rot', next+'deg');
    book.style.transform = `rotate(${next}deg)`;
  });

  const remove = document.createElement('button');
  remove.className = 'remove-btn';
  remove.setAttribute('aria-label','Remove book');
  remove.textContent = 'âœ•';
  remove.addEventListener('click', (e)=>{
    e.stopPropagation();
    book.remove();
    if(selectedBook === book) selectedBook = null;
  });

  const img = new Image();
  img.alt = '';
  img.crossOrigin = 'anonymous';
  img.referrerPolicy = 'no-referrer';
  img.src = src;

  img.onload = ()=>{
    const padPx = 6;
    const targetH = shelf.clientHeight - (padPx*2);
    const scale = targetH / (img.naturalHeight || 2100);
    const w = Math.max(64, Math.round((img.naturalWidth || 1400) * scale));
    book.style.height = targetH + 'px';
    book.style.width = w + 'px';

    const leftLimit = 6;
    const rightLimit = shelf.clientWidth - w - 6;
    let left = (x ?? 40) - w/2;
    left = Math.max(leftLimit, Math.min(left, rightLimit));
    book.style.left = left + 'px';

    shelf.appendChild(book);
    book.appendChild(img);
    book.appendChild(remove);
    enableHorizontalDrag(book, shelf);
    enforceSpacing(shelf);
  };

  img.onerror = ()=>{
    // tiny neutral fallback so a broken cover doesn't block layout
    const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='1400' height='2100'><rect width='100%' height='100%' fill='#e9e4df'/><rect x='40' y='40' width='1320' height='2020' rx='40' fill='#f6f1ee' stroke='#d9d1c9'/></svg>`;
    img.src = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  };
}

function enableHorizontalDrag(book, shelf){
  let dragging=false, startX=0, startLeft=0;

  const onDown = (e)=>{
    if(e.target.closest('.remove-btn')) return;
    dragging=true;
    startX = (e.touches ? e.touches[0].clientX : e.clientX);
    startLeft = parseFloat(book.style.left)||0;
    book.style.transition='none';
    book.classList.add('selected');
    document.addEventListener('mousemove', onMove);
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('mouseup', onUp, {once:true});
    document.addEventListener('touchend', onUp, {once:true});
  };

  const onMove = (e)=>{
    if(!dragging) return;
    const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
    const dx = clientX - startX;
    const shelfRect = shelf.getBoundingClientRect();
    const w = (book.getBoundingClientRect().width||parseFloat(book.style.width)||80);
    let left = startLeft + dx;
    const min = 6;
    const max = shelfRect.width - w - 6;
    book.style.left = Math.max(min, Math.min(left, max)) + 'px';
    if(e.cancelable) e.preventDefault();
  };

  const onUp = ()=>{
    dragging=false;
    book.style.transition='';
    enforceSpacing(shelf);
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('touchmove', onMove);
  };

  book.addEventListener('mousedown', onDown);
  book.addEventListener('touchstart', onDown, {passive:true});
}

/* keep neat spacing between books */
function enforceSpacing(shelf){
  const gutter = 12, pad = 6;
  const shelfW = shelf.clientWidth;
  const books = Array.from(shelf.querySelectorAll('.book'));
  if(!books.length) return;

  const arr = books.map(el=>{
    const w = el.getBoundingClientRect().width || parseFloat(el.style.width) || 80;
    const left = parseFloat(el.style.left) || 0;
    return {el, w, left};
  }).sort((a,b)=>a.left - b.left);

  arr[0].left = Math.max(pad, arr[0].left);
  for(let i=1;i<arr.length;i++){
    const prev = arr[i-1];
    const minLeft = prev.left + prev.w + gutter;
    arr[i].left = Math.max(minLeft, arr[i].left);
  }

  const overflow = (arr.at(-1).left + arr.at(-1).w + pad) - shelfW;
  if(overflow > 0){
    for(let i=arr.length-1;i>=0;i--){
      arr[i].left = Math.max(pad + i * gutter, arr[i].left - overflow);
    }
    for(let i=1;i<arr.length;i++){
      arr[i].left = Math.max(arr[i].left, arr[i-1].left + arr[i-1].w + gutter);
    }
  }
  arr.forEach(it => it.el.style.left = Math.round(it.left) + 'px');
}

/* ========= Discover: create cards ========= */
function makeCard({src}){
  const card = document.createElement('div');
  card.className = 'book-card';

  const im=new Image();
  im.decoding='async'; im.loading='lazy'; im.src=src; im.alt='';
  im.crossOrigin='anonymous';
  card.appendChild(im);

  const payload = {src};
  card.draggable = true;
  card.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', JSON.stringify(payload));
  });
  return card;
}

/* ========= Editions-based cover fetching ========= */
async function fetchEditionCovers(workKey, max = 40) {
  const images = [];
  let offset = 0;
  const pageSize = 100;
  while (images.length < max) {
    const url = `https://openlibrary.org${workKey}/editions.json?limit=${pageSize}&offset=${offset}`;
    const res = await fetch(url);
    if (!res.ok) break;
    const data = await res.json();
    const entries = Array.isArray(data.entries) ? data.entries : [];
    if (!entries.length) break;

    for (const ed of entries) {
      if (Array.isArray(ed.covers) && ed.covers.length) {
        ed.covers.forEach(id => images.push(`https://covers.openlibrary.org/b/id/${id}-L.jpg`));
      } else if (ed.cover_id) {
        images.push(`https://covers.openlibrary.org/b/id/${ed.cover_id}-L.jpg`);
      } else if (ed.key) {
        const olid = ed.key.split('/').pop();
        images.push(`https://covers.openlibrary.org/b/olid/${olid}-L.jpg`);
      }
      if (images.length >= max) break;
    }

    if (!data.links || !data.links.next) break;
    offset += pageSize;
  }

  const seen = new Set();
  return images.filter(u => (seen.has(u) ? false : (seen.add(u), true)));
}

/* ========= Search: many vintage jackets for one title ========= */
async function searchBooks(q) {
  resultsEl.innerHTML = '';
  if (!q || !q.trim()) { return featuredCovers(); }

  try {
    // find a good work match
    const workSearchUrl = `https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&limit=10`;
    const sres = await fetch(workSearchUrl);
    const sdata = await sres.json();
    const docs = Array.isArray(sdata.docs) ? sdata.docs : [];

    const withWork = docs.find(d =>
      (Array.isArray(d.key) ? d.key.some(k => k.startsWith('/works/')) :
       (typeof d.key === 'string' && d.key.startsWith('/works/')))
    );
    let workKey = null;

    if (withWork) {
      workKey = Array.isArray(withWork.key)
        ? (withWork.key.find(k => k.startsWith('/works/')) || withWork.key[0])
        : withWork.key;
    } else if (docs[0]?.key?.startsWith?.('/works/')) {
      workKey = docs[0].key;
    } else if (docs[0]?.work_key?.[0]) {
      workKey = docs[0].work_key[0];
    }

    let images = [];
    if (workKey) {
      images = await fetchEditionCovers(workKey, 48);
    } else {
      // fallback: per-doc covers/olids
      for (const d of docs) {
        if (Array.isArray(d.edition_key)) {
          for (const olid of d.edition_key) {
            images.push(`https://covers.openlibrary.org/b/olid/${olid}-L.jpg`);
            if (images.length >= 36) break;
          }
        } else if (d.cover_i) {
          images.push(`https://covers.openlibrary.org/b/id/${d.cover_i}-L.jpg`);
        }
        if (images.length >= 36) break;
      }
      const seen = new Set();
      images = images.filter(u => (seen.has(u) ? false : (seen.add(u), true)));
    }

    if (!images.length) {
      resultsEl.innerHTML = `<div style="grid-column:1/-1;color:#7b6d66;">No vintage jackets found. Try another title or spelling.</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    images.forEach(src => frag.appendChild(makeCard({src})));
    resultsEl.appendChild(frag);
  } catch (err) {
    console.error(err);
    resultsEl.innerHTML = `<div style="grid-column:1/-1;color:#7b6d66;">Search error. Please try again.</div>`;
  }
}

/* ========= Featured: pick works, then show editions ========= */
async function featuredCovers() {
  resultsEl.innerHTML = '';
  const seeds = ['Pride and Prejudice','Jane Eyre','Little Women'];
  const images = [];

  for (const title of seeds) {
    try {
      const u = `https://openlibrary.org/search.json?q=${encodeURIComponent(title)}&limit=5`;
      const r = await fetch(u);
      const d = await r.json();
      const docs = Array.isArray(d.docs) ? d.docs : [];
      const wdoc = docs.find(x =>
        (Array.isArray(x.key) ? x.key.some(k => k.startsWith('/works/')) :
         (typeof x.key === 'string' && x.key.startsWith('/works/')))
      ) || docs[0];

      let workKey = null;
      if (wdoc) {
        workKey = Array.isArray(wdoc.key)
          ? (wdoc.key.find(k => k.startsWith('/works/')) || wdoc.key[0])
          : wdoc.key;
      }
      if (workKey) {
        const imgs = await fetchEditionCovers(workKey, 18);
        images.push(...imgs);
      }
      if (images.length >= 36) break;
    } catch (_) {}
  }

  const dedup = Array.from(new Set(images)).slice(0, 36);
  if (!dedup.length) {
    resultsEl.innerHTML = `<div style="grid-column:1/-1;color:#7b6d66;">No featured covers right now. Try a search above.</div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  dedup.forEach(src => frag.appendChild(makeCard({src})));
  resultsEl.appendChild(frag);
}

/* ========= Fairy bulbs ========= */
function buildFairyBulbs(n=28){
  fairy.innerHTML = '';
  for(let i=0;i<n;i++){
    const s = document.createElement('span');
    s.className = 'bulb';
    fairy.appendChild(s);
  }
}

/* ========= Style Switching ========= */
function applyStyle(val){
  document.body.classList.remove('theme-classic','theme-dark','theme-coquette','theme-cottage');
  if(val==='dark') document.body.classList.add('theme-dark');
  else if(val==='coquette') document.body.classList.add('theme-coquette');
  else if(val==='cottage') document.body.classList.add('theme-cottage');
  else document.body.classList.add('theme-classic');
}

/* ========= Clear & Save ========= */
function clearShelves(){
  $$('.shelf .book').forEach(b => b.remove());
  selectedBook = null;
}

async function savePNG(){
  fairy.classList.toggle('hidden', !lightsToggle.checked);
  const canvas = await html2canvas(board, {useCORS:true, backgroundColor:null, scale:2});
  const data = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.href = data; a.download = `booktok-shelf-${stamp}.png`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ========= Bindings ========= */
$('#go').addEventListener('click', ()=> searchBooks($('#q').value));
$('#q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ searchBooks($('#q').value); } });

shelfCountSel.addEventListener('change', ()=>{
  const n = parseInt(shelfCountSel.value,10)||3;
  renderShelves(n);
});

styleSel.addEventListener('change', ()=>{
  applyStyle(styleSel.value);
});

lightsToggle.addEventListener('change', ()=>{
  fairy.classList.toggle('hidden', !lightsToggle.checked);
});

clearBtn.addEventListener('click', ()=>{
  if (event && (event.shiftKey || confirm('Clear all shelves?'))) clearShelves();
});

saveBtn.addEventListener('click', async ()=>{
  saveBtn.disabled = true; saveBtn.textContent = 'Savingâ€¦';
  try { await savePNG(); } finally { saveBtn.disabled = false; saveBtn.textContent = 'Save PNG'; }
});

document.addEventListener('keydown', (e)=>{
  if(!selectedBook) return;
  if(e.key === 'Delete' || e.key === 'Backspace'){
    selectedBook.remove();
    selectedBook = null;
  }
});

document.addEventListener('click', (e)=>{
  if(selectedBook && !e.target.closest('.book')){
    selectedBook.classList.remove('selected');
    selectedBook = null;
  }
});

/* ========= Init ========= */
renderShelves(parseInt(shelfCountSel.value,10)||3);
applyStyle(styleSel.value);
buildFairyBulbs(28);
lightsToggle.checked = true;
fairy.classList.toggle('hidden', !lightsToggle.checked);
featuredCovers(); // pre-populate with multiple vintage jackets
</script>
</body>
</html>


